<!-- Dashboard Header -->
<div class="dashboard-page-header">
  <div>
    <h1>Welcome, <%= user.firstName %>! ðŸ‘·</h1>
    <p class="subtitle">Manage your contractor dashboard and find new projects</p>
  </div>
  <% if (contractor) { %>
    <a href="/contractors/<%= contractor.slug %>" class="btn btn-secondary" target="_blank">
      <i data-lucide="external-link"></i>
      View Public Profile
    </a>
  <% } else { %>
    <a href="/contractors/setup" class="btn btn-primary">
      <i data-lucide="user-plus"></i>
      Complete Profile
    </a>
  <% } %>
</div>

<% if (!contractor) { %>
  <!-- Setup Profile CTA -->
  <div class="setup-banner">
    <div class="setup-banner-icon">
      <i data-lucide="alert-circle"></i>
    </div>
    <div class="setup-banner-content">
      <h3>Complete Your Professional Profile</h3>
      <p>Set up your contractor profile to start receiving project requests from homeowners. Showcase your work and grow your business!</p>
    </div>
    <a href="/contractors/setup" class="btn btn-primary btn-lg">
      <i data-lucide="arrow-right"></i>
      Set Up Profile
    </a>
  </div>
<% } else { %>
  <!-- Stats Row -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-icon green">
        <i data-lucide="eye"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value"><%= stats.profileViews %></div>
        <div class="stat-label">Profile Views</div>
        <div class="stat-trend up">
          <i data-lucide="trending-up"></i> +12% this week
        </div>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon purple">
        <i data-lucide="briefcase"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value"><%= stats.projectsReceived %></div>
        <div class="stat-label">Projects Received</div>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon orange">
        <i data-lucide="check-circle"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value"><%= stats.projectsAccepted %></div>
        <div class="stat-label">Projects Accepted</div>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon blue">
        <i data-lucide="star"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value"><%= stats.avgRating > 0 ? stats.avgRating.toFixed(1) : 'N/A' %></div>
        <div class="stat-label">Average Rating</div>
      </div>
    </div>
  </div>
  
  <!-- Availability Banner -->
  <div class="availability-banner <%= contractor.availability?.status || 'available' %>">
    <div class="availability-info">
      <span class="availability-dot"></span>
      <span class="availability-text">
        <% if (contractor.availability?.status === 'available') { %>
          You're <strong>Available</strong> for new projects
        <% } else if (contractor.availability?.status === 'busy') { %>
          You're currently <strong>Busy</strong> - Limited capacity
        <% } else { %>
          You're marked as <strong>Unavailable</strong>
        <% } %>
      </span>
    </div>
    <a href="/contractors/profile/edit" class="btn btn-sm btn-secondary">
      <i data-lucide="settings"></i>
      Update Status
    </a>
  </div>
  
  <!-- Main Dashboard Grid -->
  <div class="dashboard-grid">
    <!-- Left Column - Available Projects -->
    <div>
      <div class="dashboard-section">
        <div class="section-header">
          <h2>ðŸ”¥ Available Projects</h2>
          <a href="/contractors/projects/available" class="btn btn-sm btn-ghost">View All</a>
        </div>
        
        <% if (availableProjects && availableProjects.length > 0) { %>
          <div class="projects-list">
            <% availableProjects.forEach(project => { %>
              <div class="project-item marketplace-item">
                <div class="project-thumb">
                  <% if (project.designVariants && project.designVariants.length > 0) { %>
                    <img src="<%= project.designVariants[0].imageUrl || project.designVariants[0].thumbnailUrl %>" alt="<%= project.title %>">
                  <% } else if (project.originalImages && project.originalImages.length > 0) { %>
                    <img src="<%= project.originalImages[0].url %>" alt="<%= project.title %>">
                  <% } else { %>
                    <div class="project-thumb-placeholder">
                      <i data-lucide="image"></i>
                    </div>
                  <% } %>
                </div>
                <div class="project-details">
                  <h3><%= project.title %></h3>
                  <div class="project-meta">
                    <span><i data-lucide="home"></i> <%= project.roomType %></span>
                    <span><i data-lucide="user"></i> <%= project.user.firstName %> <%= project.user.lastName.charAt(0) %>.</span>
                    <% if (project.budget && project.budget.max) { %>
                      <span class="budget-tag"><i data-lucide="euro"></i> â‚¬<%= project.budget.max.toLocaleString() %></span>
                    <% } %>
                  </div>
                  <p class="project-excerpt"><%= project.description.substring(0, 80) %>...</p>
                </div>
                <div class="project-actions" style="flex-direction: column;">
                  <a href="/projects/share/<%= project.shareToken %>" class="btn btn-sm btn-secondary">
                    <i data-lucide="eye"></i> View
                  </a>
                  <button class="btn btn-sm btn-primary" onclick="expressInterest('<%= project._id %>')">
                    <i data-lucide="hand"></i> Apply
                  </button>
                </div>
              </div>
            <% }) %>
          </div>
        <% } else { %>
          <div class="section-content">
            <div class="empty-state">
              <div class="empty-state-icon">
                <i data-lucide="search"></i>
              </div>
              <h3>No matching projects</h3>
              <p>New projects matching your specialties will appear here.</p>
            </div>
          </div>
        <% } %>
      </div>
    </div>
    
    <!-- Right Column -->
    <div>
      <!-- Profile Completion -->
      <div class="dashboard-section" style="margin-bottom: var(--spacing-lg);">
        <div class="section-header">
          <h2>Profile Status</h2>
        </div>
        <div class="section-content">
          <div class="profile-completion">
            <div class="completion-header">
              <span>Profile Completion</span>
              <span class="completion-percent">75%</span>
            </div>
            <div class="completion-bar">
              <div class="completion-fill" style="width: 75%"></div>
            </div>
            <ul class="completion-checklist">
              <li class="completed"><i data-lucide="check-circle"></i> Basic information</li>
              <li class="completed"><i data-lucide="check-circle"></i> Contact details</li>
              <li class="completed"><i data-lucide="check-circle"></i> Service areas</li>
              <li><i data-lucide="circle"></i> Add portfolio photos</li>
              <li><i data-lucide="circle"></i> Upload certifications</li>
            </ul>
            <a href="/contractors/profile/edit" class="btn btn-sm btn-outline" style="width: 100%; margin-top: var(--spacing-md);">
              Complete Profile
            </a>
          </div>
        </div>
      </div>
      
      <!-- Quick Actions -->
      <div class="dashboard-section" style="margin-bottom: var(--spacing-lg);">
        <div class="section-header">
          <h2>Quick Actions</h2>
        </div>
        <div class="section-content">
          <div class="quick-actions-grid">
            <a href="/contractors/projects/available" class="quick-action">
              <i data-lucide="briefcase"></i>
              <span>Browse Projects</span>
            </a>
            <a href="/contractors/profile/edit" class="quick-action">
              <i data-lucide="building-2"></i>
              <span>Edit Profile</span>
            </a>
            <a href="/dashboard/messages" class="quick-action">
              <i data-lucide="message-square"></i>
              <span>Messages</span>
            </a>
            <a href="/dashboard/settings" class="quick-action">
              <i data-lucide="settings"></i>
              <span>Settings</span>
            </a>
          </div>
        </div>
      </div>
      
      <!-- Premium CTA -->
      <% if (!contractor.isPremium) { %>
        <div class="dashboard-section" style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 140, 0, 0.1)); border-color: rgba(255, 215, 0, 0.3);">
          <div class="section-content" style="text-align: center; padding: var(--spacing-xl);">
            <div style="font-size: 2.5rem; margin-bottom: var(--spacing-md);">ðŸ‘‘</div>
            <h3 style="margin-bottom: var(--spacing-sm);">Boost Your Profile</h3>
            <p style="color: var(--text-secondary); margin-bottom: var(--spacing-lg); font-size: 0.9rem;">
              Get featured placement, priority notifications, and a verified badge.
            </p>
            <a href="/pricing" class="btn btn-primary">
              <i data-lucide="crown"></i>
              Go Premium
            </a>
          </div>
        </div>
      <% } %>
    </div>
  </div>
<% } %>

<style>
  .setup-banner {
    display: flex;
    align-items: center;
    gap: var(--spacing-xl);
    padding: var(--spacing-2xl);
    background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 212, 255, 0.05));
    border: 1px solid rgba(0, 255, 136, 0.3);
    border-radius: var(--radius-xl);
    margin-bottom: var(--spacing-2xl);
  }
  
  .setup-banner-icon {
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--accent-gradient);
    border-radius: 50%;
    color: #000;
    flex-shrink: 0;
  }
  
  .setup-banner-icon i {
    width: 40px;
    height: 40px;
  }
  
  .setup-banner-content {
    flex: 1;
  }
  
  .setup-banner-content h3 {
    font-size: 1.25rem;
    margin-bottom: var(--spacing-sm);
  }
  
  .setup-banner-content p {
    color: var(--text-secondary);
  }
  
  .availability-banner {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-md) var(--spacing-xl);
    border-radius: var(--radius-lg);
    margin-bottom: var(--spacing-xl);
  }
  
  .availability-banner.available {
    background: rgba(0, 255, 136, 0.1);
    border: 1px solid rgba(0, 255, 136, 0.3);
  }
  
  .availability-banner.busy {
    background: rgba(245, 158, 11, 0.1);
    border: 1px solid rgba(245, 158, 11, 0.3);
  }
  
  .availability-banner.unavailable {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
  }
  
  .availability-info {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
  }
  
  .availability-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
  }
  
  .available .availability-dot { background: var(--success); }
  .busy .availability-dot { background: #f59e0b; }
  .unavailable .availability-dot { background: var(--error); }
  
  .marketplace-item {
    cursor: pointer;
  }
  
  .project-excerpt {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-top: var(--spacing-sm);
  }
  
  .budget-tag {
    background: rgba(0, 255, 136, 0.1);
    color: var(--accent-primary);
    padding: 0.1rem 0.5rem;
    border-radius: var(--radius-sm);
    font-weight: 600;
  }
  
  .profile-completion {
    padding: var(--spacing-sm);
  }
  
  .completion-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: var(--spacing-sm);
    font-size: 0.9rem;
  }
  
  .completion-percent {
    font-weight: 700;
    color: var(--accent-primary);
  }
  
  .completion-bar {
    height: 8px;
    background: var(--bg-secondary);
    border-radius: var(--radius-full);
    margin-bottom: var(--spacing-lg);
    overflow: hidden;
  }
  
  .completion-fill {
    height: 100%;
    background: var(--accent-gradient);
    border-radius: var(--radius-full);
  }
  
  .completion-checklist {
    list-style: none;
  }
  
  .completion-checklist li {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-sm) 0;
    font-size: 0.85rem;
    color: var(--text-muted);
  }
  
  .completion-checklist li.completed {
    color: var(--success);
  }
  
  .completion-checklist li i {
    width: 16px;
    height: 16px;
  }
  
  @media (max-width: 768px) {
    .setup-banner {
      flex-direction: column;
      text-align: center;
    }
    
    .availability-banner {
      flex-direction: column;
      gap: var(--spacing-md);
      text-align: center;
    }
  }
</style>

<script>
  function expressInterest(projectId) {
    const message = prompt('Enter a message for the client (optional):');
    if (message === null) return;
    
    const quotation = prompt('Enter your estimated quote (â‚¬) (optional):');
    
    fetch(`/contractors/projects/${projectId}/interest`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message, quotation })
    })
    .then(res => {
      if (res.ok) {
        CraftyCrib.showToast('Interest expressed successfully!');
        setTimeout(() => window.location.reload(), 1500);
      } else {
        return res.json().then(data => {
          CraftyCrib.showToast(data.error || 'Failed to express interest', 'error');
        });
      }
    })
    .catch(() => CraftyCrib.showToast('An error occurred', 'error'));
  }
</script>
